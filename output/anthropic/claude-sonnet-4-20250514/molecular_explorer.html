<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecular Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
            max-width: 300px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        select, button, input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider-value {
            min-width: 40px;
            font-weight: bold;
            color: #667eea;
        }
        
        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
        }
        
        .hidden {
            display: none;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            z-index: 200;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        
        <div id="loading" class="hidden">Loading...</div>
        
        <div id="controls">
            <div class="control-group">
                <label>Sample Molecules</label>
                <select id="moleculeSelect">
                    <option value="water">Water (H₂O)</option>
                    <option value="caffeine">Caffeine (C₈H₁₀N₄O₂)</option>
                    <option value="dna">DNA Segment</option>
                    <option value="benzene">Benzene (C₆H₆)</option>
                    <option value="methane">Methane (CH₄)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Visualization Mode</label>
                <select id="modeSelect">
                    <option value="ball-stick">Ball and Stick</option>
                    <option value="space-filling">Space Filling</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Explode Factor</label>
                <div class="slider-container">
                    <input type="range" id="explodeSlider" min="0" max="3" step="0.1" value="0">
                    <span class="slider-value" id="explodeValue">0</span>
                </div>
            </div>
            
            <div class="control-group">
                <label>Clipping Plane</label>
                <div class="slider-container">
                    <input type="range" id="clipSlider" min="-10" max="10" step="0.5" value="10">
                    <span class="slider-value" id="clipValue">Off</span>
                </div>
            </div>
            
            <div class="control-group">
                <button id="animateBtn">Toggle Animation</button>
                <button id="resetBtn">Reset View</button>
                <button id="snapshotBtn">Export Snapshot</button>
            </div>
        </div>
        
        <div id="info">
            <div>Molecule: <span id="moleculeName">Water</span></div>
            <div>Formula: <span id="moleculeFormula">H₂O</span></div>
            <div>Atoms: <span id="atomCount">3</span></div>
            <div>Bonds: <span id="bondCount">2</span></div>
        </div>
    </div>

    <script>
        // Global variables
        let scene, camera, renderer, controls;
        let moleculeGroup, atomGroup, bondGroup;
        let currentMolecule = 'water';
        let renderMode = 'ball-stick';
        let isAnimating = false;
        let explodeFactor = 0;
        let clippingPlane;
        
        // Element properties
        const elementData = {
            'H': { color: 0xFFFFFF, radius: 0.32 },
            'C': { color: 0x909090, radius: 0.77 },
            'N': { color: 0x3050F8, radius: 0.75 },
            'O': { color: 0xFF0D0D, radius: 0.73 },
            'P': { color: 0xFF8000, radius: 1.06 },
            'S': { color: 0xFFFF30, radius: 1.02 }
        };
        
        // Molecular structures
        const molecules = {
            water: {
                name: "Water",
                formula: "H₂O",
                atoms: [
                    { element: 'O', x: 0, y: 0, z: 0 },
                    { element: 'H', x: 0.96, y: 0, z: 0 },
                    { element: 'H', x: -0.24, y: 0.93, z: 0 }
                ]
            },
            caffeine: {
                name: "Caffeine",
                formula: "C₈H₁₀N₄O₂",
                atoms: [
                    { element: 'C', x: 0, y: 0, z: 0 },
                    { element: 'C', x: 1.4, y: 0, z: 0 },
                    { element: 'C', x: 2.1, y: 1.2, z: 0 },
                    { element: 'C', x: 1.4, y: 2.4, z: 0 },
                    { element: 'C', x: 0, y: 2.4, z: 0 },
                    { element: 'C', x: -0.7, y: 1.2, z: 0 },
                    { element: 'N', x: -0.7, y: -1.2, z: 0 },
                    { element: 'N', x: 2.1, y: -1.2, z: 0 },
                    { element: 'N', x: 3.5, y: 1.2, z: 0 },
                    { element: 'N', x: 2.1, y: 3.6, z: 0 },
                    { element: 'O', x: -1.4, y: 2.4, z: 0 },
                    { element: 'O', x: -0.7, y: 3.6, z: 0 },
                    { element: 'H', x: -1.4, y: -1.2, z: 0 },
                    { element: 'H', x: -0.7, y: -2.4, z: 0 },
                    { element: 'H', x: 2.8, y: -1.2, z: 0 },
                    { element: 'H', x: 2.1, y: -2.4, z: 0 },
                    { element: 'H', x: 4.2, y: 1.2, z: 0 },
                    { element: 'H', x: 3.5, y: 0, z: 0 },
                    { element: 'H', x: 2.8, y: 3.6, z: 0 },
                    { element: 'H', x: 1.4, y: 4.8, z: 0 }
                ]
            },
            dna: {
                name: "DNA Segment",
                formula: "DNA",
                atoms: [
                    // Phosphate backbone
                    { element: 'P', x: 0, y: 0, z: 0 },
                    { element: 'O', x: 1.5, y: 0, z: 0 },
                    { element: 'O', x: -1.5, y: 0, z: 0 },
                    { element: 'O', x: 0, y: 1.5, z: 0 },
                    { element: 'O', x: 0, y: -1.5, z: 0 },
                    // Sugar ring
                    { element: 'C', x: 0, y: 3, z: 0 },
                    { element: 'C', x: 1.2, y: 3.8, z: 0 },
                    { element: 'C', x: 2.4, y: 3, z: 0 },
                    { element: 'C', x: 2.4, y: 1.5, z: 0 },
                    { element: 'O', x: 1.2, y: 0.7, z: 0 },
                    // Base (simplified)
                    { element: 'N', x: 3.6, y: 3.8, z: 0 },
                    { element: 'C', x: 4.8, y: 3, z: 0 },
                    { element: 'N', x: 4.8, y: 1.5, z: 0 },
                    { element: 'C', x: 3.6, y: 0.7, z: 0 },
                    // Hydrogens
                    { element: 'H', x: -0.7, y: 3.8, z: 0 },
                    { element: 'H', x: 1.2, y: 4.8, z: 0 },
                    { element: 'H', x: 2.4, y: 0.7, z: 0 },
                    { element: 'H', x: 5.5, y: 3.8, z: 0 },
                    { element: 'H', x: 3.6, y: -0.3, z: 0 }
                ]
            },
            benzene: {
                name: "Benzene",
                formula: "C₆H₆",
                atoms: [
                    { element: 'C', x: 1.4, y: 0, z: 0 },
                    { element: 'C', x: 0.7, y: 1.2, z: 0 },
                    { element: 'C', x: -0.7, y: 1.2, z: 0 },
                    { element: 'C', x: -1.4, y: 0, z: 0 },
                    { element: 'C', x: -0.7, y: -1.2, z: 0 },
                    { element: 'C', x: 0.7, y: -1.2, z: 0 },
                    { element: 'H', x: 2.5, y: 0, z: 0 },
                    { element: 'H', x: 1.25, y: 2.2, z: 0 },
                    { element: 'H', x: -1.25, y: 2.2, z: 0 },
                    { element: 'H', x: -2.5, y: 0, z: 0 },
                    { element: 'H', x: -1.25, y: -2.2, z: 0 },
                    { element: 'H', x: 1.25, y: -2.2, z: 0 }
                ]
            },
            methane: {
                name: "Methane",
                formula: "CH₄",
                atoms: [
                    { element: 'C', x: 0, y: 0, z: 0 },
                    { element: 'H', x: 1.1, y: 1.1, z: 1.1 },
                    { element: 'H', x: -1.1, y: -1.1, z: 1.1 },
                    { element: 'H', x: -1.1, y: 1.1, z: -1.1 },
                    { element: 'H', x: 1.1, y: -1.1, z: -1.1 }
                ]
            }
        };
        
        // Initialize the application
        function init() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000511);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);
            
            // Create renderer
            const canvas = document.getElementById('canvas');
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true, 
                preserveDrawingBuffer: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Create clipping plane
            clippingPlane = new THREE.Plane(new THREE.Vector3(1, 0, 0), 10);
            renderer.clippingPlanes = [clippingPlane];
            renderer.localClippingEnabled = true;
            
            // Create controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Add lights
            setupLights();
            
            // Create molecule group
            moleculeGroup = new THREE.Group();
            scene.add(moleculeGroup);
            
            // Load initial molecule
            loadMolecule(currentMolecule);
            
            // Setup event listeners
            setupEventListeners();
            
            // Start render loop
            animate();
        }
        
        function setupLights() {
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            
            // Directional lights
            const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
            light1.position.set(10, 10, 10);
            light1.castShadow = true;
            light1.shadow.mapSize.width = 2048;
            light1.shadow.mapSize.height = 2048;
            scene.add(light1);
            
            const light2 = new THREE.DirectionalLight(0xffffff, 0.5);
            light2.position.set(-10, -10, -10);
            scene.add(light2);
            
            // Point light
            const pointLight = new THREE.PointLight(0x00ff88, 0.3, 100);
            pointLight.position.set(0, 0, 10);
            scene.add(pointLight);
        }
        
        function loadMolecule(moleculeName) {
            currentMolecule = moleculeName;
            const molData = molecules[moleculeName];
            
            // Clear existing molecule
            moleculeGroup.clear();
            
            // Create atom and bond groups
            atomGroup = new THREE.Group();
            bondGroup = new THREE.Group();
            moleculeGroup.add(atomGroup);
            moleculeGroup.add(bondGroup);
            
            // Create atoms
            createAtoms(molData.atoms);
            
            // Create bonds
            const bonds = inferBonds(molData.atoms);
            createBonds(molData.atoms, bonds);
            
            // Update info display
            updateInfo(molData, bonds.length);
            
            // Center molecule
            centerMolecule();
        }
        
        function createAtoms(atoms) {
            atoms.forEach((atom, index) => {
                const element = elementData[atom.element];
                const radius = renderMode === 'space-filling' ? 
                    element.radius * 1.5 : element.radius * 0.8;
                
                const geometry = new THREE.SphereGeometry(radius, 32, 32);
                const material = new THREE.MeshPhongMaterial({ 
                    color: element.color,
                    shininess: 100,
                    specular: 0x222222
                });
                
                const sphere = new THREE.Mesh(geometry, material);
                sphere.position.set(atom.x, atom.y, atom.z);
                sphere.castShadow = true;
                sphere.receiveShadow = true;
                sphere.userData = { 
                    element: atom.element, 
                    originalPosition: new THREE.Vector3(atom.x, atom.y, atom.z),
                    index: index
                };
                
                atomGroup.add(sphere);
            });
        }
        
        function inferBonds(atoms) {
            const bonds = [];
            const bondLengths = {
                'H-H': 0.74, 'H-C': 1.09, 'H-N': 1.01, 'H-O': 0.96,
                'C-C': 1.54, 'C-N': 1.47, 'C-O': 1.43,
                'N-N': 1.45, 'N-O': 1.40,
                'O-O': 1.48, 'P-O': 1.60
            };
            
            for (let i = 0; i < atoms.length; i++) {
                for (let j = i + 1; j < atoms.length; j++) {
                    const atom1 = atoms[i];
                    const atom2 = atoms[j];
                    
                    const distance = Math.sqrt(
                        Math.pow(atom1.x - atom2.x, 2) +
                        Math.pow(atom1.y - atom2.y, 2) +
                        Math.pow(atom1.z - atom2.z, 2)
                    );
                    
                    const bondKey = [atom1.element, atom2.element].sort().join('-');
                    const expectedBondLength = bondLengths[bondKey] || 2.0;
                    
                    if (distance < expectedBondLength * 1.3) {
                        bonds.push({ from: i, to: j, distance: distance });
                    }
                }
            }
            
            return bonds;
        }
        
        function createBonds(atoms, bonds) {
            if (renderMode === 'space-filling') return;
            
            bonds.forEach(bond => {
                const atom1 = atoms[bond.from];
                const atom2 = atoms[bond.to];
                
                const start = new THREE.Vector3(atom1.x, atom1.y, atom1.z);
                const end = new THREE.Vector3(atom2.x, atom2.y, atom2.z);
                const direction = end.clone().sub(start);
                const distance = direction.length();
                
                const geometry = new THREE.CylinderGeometry(0.1, 0.1, distance, 8);
                const material = new THREE.MeshPhongMaterial({ color: 0x666666 });
                
                const cylinder = new THREE.Mesh(geometry, material);
                
                // Position and orient the cylinder
                cylinder.position.copy(start.clone().add(direction.clone().multiplyScalar(0.5)));
                cylinder.lookAt(end);
                cylinder.rotateX(Math.PI / 2);
                
                cylinder.userData = {
                    from: bond.from,
                    to: bond.to,
                    originalStart: start.clone(),
                    originalEnd: end.clone()
                };
                
                bondGroup.add(cylinder);
            });
        }
        
        function centerMolecule() {
            const box = new THREE.Box3().setFromObject(moleculeGroup);
            const center = box.getCenter(new THREE.Vector3());
            moleculeGroup.position.sub(center);
        }
        
        function updateVisualization() {
            loadMolecule(currentMolecule);
            applyExplodeEffect();
        }
        
        function applyExplodeEffect() {
            atomGroup.children.forEach(atom => {
                const originalPos = atom.userData.originalPosition;
                const explodeDirection = originalPos.clone().normalize();
                const newPosition = originalPos.clone().add(
                    explodeDirection.multiplyScalar(explodeFactor)
                );
                atom.position.copy(newPosition);
            });
            
            // Update bonds for exploded view
            bondGroup.children.forEach(bond => {
                const fromAtom = atomGroup.children[bond.userData.from];
                const toAtom = atomGroup.children[bond.userData.to];
                
                const start = fromAtom.position.clone();
                const end = toAtom.position.clone();
                const direction = end.clone().sub(start);
                const distance = direction.length();
                
                // Update bond geometry
                bond.geometry.dispose();
                bond.geometry = new THREE.CylinderGeometry(0.1, 0.1, distance, 8);
                
                // Update position and orientation
                bond.position.copy(start.clone().add(direction.clone().multiplyScalar(0.5)));
                bond.lookAt(end);
                bond.rotateX(Math.PI / 2);
            });
        }
        
        function setupEventListeners() {
            // Molecule selection
            document.getElementById('moleculeSelect').addEventListener('change', (e) => {
                loadMolecule(e.target.value);
            });
            
            // Render mode
            document.getElementById('modeSelect').addEventListener('change', (e) => {
                renderMode = e.target.value;
                updateVisualization();
            });
            
            // Explode slider
            const explodeSlider = document.getElementById('explodeSlider');
            const explodeValue = document.getElementById('explodeValue');
            explodeSlider.addEventListener('input', (e) => {
                explodeFactor = parseFloat(e.target.value);
                explodeValue.textContent = explodeFactor.toFixed(1);
                applyExplodeEffect();
            });
            
            // Clipping slider
            const clipSlider = document.getElementById('clipSlider');
            const clipValue = document.getElementById('clipValue');
            clipSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                clippingPlane.constant = value;
                clipValue.textContent = value >= 10 ? 'Off' : value.toFixed(1);
            });
            
            // Buttons
            document.getElementById('animateBtn').addEventListener('click', toggleAnimation);
            document.getElementById('resetBtn').addEventListener('click', resetView);
            document.getElementById('snapshotBtn').addEventListener('click', exportSnapshot);
            
            // Window resize
            window.addEventListener('resize', onWindowResize);
        }
        
        function toggleAnimation() {
            isAnimating = !isAnimating;
            document.getElementById('animateBtn').textContent = 
                isAnimating ? 'Stop Animation' : 'Toggle Animation';
        }
        
        function resetView() {
            camera.position.set(5, 5, 5);
            controls.reset();
            explodeFactor = 0;
            document.getElementById('explodeSlider').value = 0;
            document.getElementById('explodeValue').textContent = '0';
            clippingPlane.constant = 10;
            document.getElementById('clipSlider').value = 10;
            document.getElementById('clipValue').textContent = 'Off';
            applyExplodeEffect();
        }
        
        function exportSnapshot() {
            const link = document.createElement('a');
            link.download = `${currentMolecule}_${renderMode}_${Date.now()}.png`;
            link.href = renderer.domElement.toDataURL();
            link.click();
        }
        
        function updateInfo(molData, bondCount) {
            document.getElementById('moleculeName').textContent = molData.name;
            document.getElementById('moleculeFormula').textContent = molData.formula;
            document.getElementById('atomCount').textContent = molData.atoms.length;
            document.getElementById('bondCount').textContent = bondCount;
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            // Animation rotation
            if (isAnimating && moleculeGroup) {
                moleculeGroup.rotation.y += 0.01;
                moleculeGroup.rotation.x += 0.005;
            }
            
            controls.update();
            renderer.render(scene, camera);
        }
        
        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>