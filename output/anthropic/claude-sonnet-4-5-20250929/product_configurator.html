<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Product Configurator - Sports Car</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #controls-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        #controls-panel::-webkit-scrollbar {
            width: 8px;
        }

        #controls-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #controls-panel::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 10px;
        }

        h3 {
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 13px;
            font-weight: 500;
        }

        select, input[type="color"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        select:focus, input[type="color"]:focus {
            outline: none;
            border-color: #2a5298;
        }

        input[type="color"] {
            height: 45px;
            cursor: pointer;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border: 3px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-option:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .color-option.active {
            border-color: #2a5298;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #2a5298;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 26px;
            transition: 0.4s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.4s;
        }

        input:checked + .toggle-slider {
            background-color: #2a5298;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .primary-btn {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(42, 82, 152, 0.4);
        }

        .secondary-btn {
            background: #6c757d;
            color: white;
        }

        .secondary-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .camera-bookmarks {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .camera-btn {
            padding: 8px;
            font-size: 12px;
            margin-top: 0;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            z-index: 1000;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-badge {
            display: inline-block;
            background: #2a5298;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        #stats {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div>Loading 3D Configurator</div>
        <div class="loading-spinner"></div>
    </div>

    <div id="canvas-container"></div>

    <div id="controls-panel">
        <h2>ðŸš— Car Configurator</h2>

        <div class="control-group">
            <h3>Body Color</h3>
            <label>Quick Select:</label>
            <div class="color-grid" id="body-colors">
                <div class="color-option active" style="background: #e74c3c;" data-color="#e74c3c" title="Racing Red"></div>
                <div class="color-option" style="background: #3498db;" data-color="#3498db" title="Ocean Blue"></div>
                <div class="color-option" style="background: #2ecc71;" data-color="#2ecc71" title="Racing Green"></div>
                <div class="color-option" style="background: #f39c12;" data-color="#f39c12" title="Sunset Orange"></div>
                <div class="color-option" style="background: #1a1a1a;" data-color="#1a1a1a" title="Midnight Black"></div>
                <div class="color-option" style="background: #ecf0f1;" data-color="#ecf0f1" title="Pearl White"></div>
                <div class="color-option" style="background: #95a5a6;" data-color="#95a5a6" title="Silver"></div>
                <div class="color-option" style="background: #9b59b6;" data-color="#9b59b6" title="Purple"></div>
                <div class="color-option" style="background: #e67e22;" data-color="#e67e22" title="Copper"></div>
                <div class="color-option" style="background: #16a085;" data-color="#16a085" title="Teal"></div>
            </div>
            <label style="margin-top: 10px;">Custom Color:</label>
            <input type="color" id="body-color" value="#e74c3c">
        </div>

        <div class="control-group">
            <h3>Material Finish</h3>
            <label>Body Material:</label>
            <select id="body-material">
                <option value="metallic">Metallic (Default)</option>
                <option value="matte">Matte Finish</option>
                <option value="glossy">High Gloss</option>
                <option value="carbon">Carbon Fiber</option>
            </select>
        </div>

        <div class="control-group">
            <h3>Stripe Color</h3>
            <label>Quick Select:</label>
            <div class="color-grid" id="stripe-colors">
                <div class="color-option active" style="background: #ffffff;" data-color="#ffffff" title="White"></div>
                <div class="color-option" style="background: #000000;" data-color="#000000" title="Black"></div>
                <div class="color-option" style="background: #3498db;" data-color="#3498db" title="Blue"></div>
                <div class="color-option" style="background: #f39c12;" data-color="#f39c12" title="Gold"></div>
                <div class="color-option" style="background: #e74c3c;" data-color="#e74c3c" title="Red"></div>
            </div>
            <label style="margin-top: 10px;">Custom Color:</label>
            <input type="color" id="stripe-color" value="#ffffff">
        </div>

        <div class="control-group">
            <h3>Wheel Configuration</h3>
            <label>Wheel Style:</label>
            <select id="wheel-style">
                <option value="sport">Sport (5-Spoke)</option>
                <option value="racing">Racing (Multi-Spoke)</option>
                <option value="classic">Classic (Simple)</option>
            </select>
            <label style="margin-top: 10px;">Wheel Color:</label>
            <input type="color" id="wheel-color" value="#2c3e50">
        </div>

        <div class="control-group">
            <h3>Window Tint</h3>
            <label>Tint Level:</label>
            <select id="window-tint">
                <option value="0.3">Light (30%)</option>
                <option value="0.5" selected>Medium (50%)</option>
                <option value="0.7">Dark (70%)</option>
                <option value="0.9">Very Dark (90%)</option>
            </select>
        </div>

        <div class="control-group">
            <h3>Optional Parts</h3>
            <div class="toggle-group">
                <label>Racing Stripe</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="toggle-stripe" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="toggle-group">
                <label>Rear Spoiler</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="toggle-spoiler" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="toggle-group">
                <label>Side Mirrors</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="toggle-mirrors" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <div class="control-group">
            <h3>Camera Views</h3>
            <div class="camera-bookmarks">
                <button class="primary-btn camera-btn" onclick="setCameraView('front')">Front</button>
                <button class="primary-btn camera-btn" onclick="setCameraView('rear')">Rear</button>
                <button class="primary-btn camera-btn" onclick="setCameraView('side')">Side</button>
                <button class="primary-btn camera-btn" onclick="setCameraView('top')">Top</button>
            </div>
        </div>

        <div class="control-group">
            <h3>Export Configuration</h3>
            <button class="primary-btn" onclick="exportJSON()">ðŸ“„ Export as JSON</button>
            <button class="secondary-btn" onclick="exportSnapshot()">ðŸ“¸ Save Snapshot (PNG)</button>
        </div>
    </div>

    <div id="stats"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Global variables
        let scene, camera, renderer, controls;
        let carGroup, bodyMesh, stripeMesh, spoilerMesh, mirrorLeft, mirrorRight;
        let wheels = [];
        let currentConfig = {
            bodyColor: '#e74c3c',
            stripeColor: '#ffffff',
            wheelColor: '#2c3e50',
            bodyMaterial: 'metallic',
            wheelStyle: 'sport',
            windowTint: 0.5,
            showStripe: true,
            showSpoiler: true,
            showMirrors: true
        };

        // Initialize Three.js scene
        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            scene.fog = new THREE.Fog(0x1a1a2e, 50, 100);

            // Camera setup
            camera = new THREE.PerspectiveCamera(
                45,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(15, 8, 15);
            camera.lookAt(0, 0, 0);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Orbit Controls (simplified)
            setupSimpleControls();

            // Lighting
            setupLighting();

            // Ground
            createGround();

            // Create car
            createCar();

            // Environment
            createEnvironment();

            // Event listeners
            setupEventListeners();

            // Hide loading
            document.getElementById('loading').style.display = 'none';

            // Start animation
            animate();
        }

        function setupSimpleControls() {
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            let rotation = { x: 0, y: 0 };

            renderer.domElement.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            renderer.domElement.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - previousMousePosition.x;
                    const deltaY = e.clientY - previousMousePosition.y;

                    rotation.y += deltaX * 0.005;
                    rotation.x += deltaY * 0.005;

                    rotation.x = Math.max(-Math.PI / 4, Math.min(Math.PI / 4, rotation.x));

                    updateCameraPosition();

                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });

            renderer.domElement.addEventListener('mouseup', () => {
                isDragging = false;
            });

            renderer.domElement.addEventListener('wheel', (e) => {
                e.preventDefault();
                const distance = camera.position.length();
                const newDistance = distance + e.deltaY * 0.01;
                const clampedDistance = Math.max(10, Math.min(40, newDistance));
                
                camera.position.normalize().multiplyScalar(clampedDistance);
                camera.lookAt(0, 2, 0);
            });

            function updateCameraPosition() {
                const distance = camera.position.length();
                camera.position.x = distance * Math.sin(rotation.y) * Math.cos(rotation.x);
                camera.position.y = distance * Math.sin(rotation.x) + 8;
                camera.position.z = distance * Math.cos(rotation.y) * Math.cos(rotation.x);
                camera.lookAt(0, 2, 0);
            }

            controls = { rotation };
        }

        function setupLighting() {
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            // Main directional light (sun)
            const sunLight = new THREE.DirectionalLight(0xffffff, 1);
            sunLight.position.set(20, 30, 20);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            sunLight.shadow.camera.near = 0.5;
            sunLight.shadow.camera.far = 100;
            sunLight.shadow.camera.left = -30;
            sunLight.shadow.camera.right = 30;
            sunLight.shadow.camera.top = 30;
            sunLight.shadow.camera.bottom = -30;
            sunLight.shadow.bias = -0.001;
            scene.add(sunLight);

            // Fill lights
            const fillLight1 = new THREE.DirectionalLight(0x4a90e2, 0.3);
            fillLight1.position.set(-10, 10, -10);
            scene.add(fillLight1);

            const fillLight2 = new THREE.DirectionalLight(0xff9a76, 0.2);
            fillLight2.position.set(10, 5, -10);
            scene.add(fillLight2);

            // Rim light
            const rimLight = new THREE.DirectionalLight(0xffffff, 0.5);
            rimLight.position.set(0, 10, -20);
            scene.add(rimLight);

            // Hemisphere light for sky/ground color
            const hemiLight = new THREE.HemisphereLight(0x87ceeb, 0x545454, 0.3);
            scene.add(hemiLight);
        }

        function createGround() {
            // Main ground
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshStandardMaterial({
                color: 0x2a2a3e,
                roughness: 0.8,
                metalness: 0.2
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Grid
            const gridHelper = new THREE.GridHelper(100, 50, 0x444466, 0x333344);
            gridHelper.position.y = 0.01;
            scene.add(gridHelper);

            // Platform under car
            const platformGeometry = new THREE.CylinderGeometry(8, 8, 0.3, 32);
            const platformMaterial = new THREE.MeshStandardMaterial({
                color: 0x3a3a4e,
                roughness: 0.6,
                metalness: 0.4
            });
            const platform = new THREE.Mesh(platformGeometry, platformMaterial);
            platform.position.y = 0.15;
            platform.receiveShadow = true;
            platform.castShadow = true;
            scene.add(platform);
        }

        function createCar() {
            carGroup = new THREE.Group();

            // Car body (main chassis)
            const bodyGeometry = new THREE.BoxGeometry(8, 2, 4);
            const bodyMaterial = createBodyMaterial();
            bodyMesh = new THREE.Mesh(bodyGeometry, bodyMaterial);
            bodyMesh.position.y = 2;
            bodyMesh.castShadow = true;
            bodyMesh.receiveShadow = true;
            carGroup.add(bodyMesh);

            // Car roof/cabin
            const roofGeometry = new THREE.BoxGeometry(4, 1.5, 3.5);
            const roofMesh = new THREE.Mesh(roofGeometry, bodyMaterial);
            roofMesh.position.set(0, 3.25, 0);
            roofMesh.castShadow = true;
            roofMesh.receiveShadow = true;
            carGroup.add(roofMesh);

            // Hood (front slope)
            const hoodGeometry = new THREE.BoxGeometry(2, 1.5, 4);
            const hoodMesh = new THREE.Mesh(hoodGeometry, bodyMaterial);
            hoodMesh.position.set(4, 2.25, 0);
            hoodMesh.rotation.z = -0.2;
            hoodMesh.castShadow = true;
            carGroup.add(hoodMesh);

            // Trunk (rear slope)
            const trunkGeometry = new THREE.BoxGeometry(1.5, 1.3, 4);
            const trunkMesh = new THREE.Mesh(trunkGeometry, bodyMaterial);
            trunkMesh.position.set(-3.5, 2.4, 0);
            trunkMesh.rotation.z = 0.15;
            trunkMesh.castShadow = true;
            carGroup.add(trunkMesh);

            // Windows
            createWindows();

            // Racing stripe
            createStripe();

            // Wheels
            createWheels();

            // Spoiler
            createSpoiler();

            // Mirrors
            createMirrors();

            // Headlights
            createLights();

            // Bumpers
            createBumpers();

            scene.add(carGroup);
        }

        function createBodyMaterial() {
            return new THREE.MeshStandardMaterial({
                color: currentConfig.bodyColor,
                metalness: 0.7,
                roughness: 0.3,
                envMapIntensity: 1.5
            });
        }

        function createWindows() {
            const windowMaterial = new THREE.MeshStandardMaterial({
                color: 0x111111,
                metalness: 0.9,
                roughness: 0.1,
                transparent: true,
                opacity: currentConfig.windowTint
            });

            // Front windshield
            const frontWindowGeo = new THREE.PlaneGeometry(3, 1.3);
            const frontWindow = new THREE.Mesh(frontWindowGeo, windowMaterial);
            frontWindow.position.set(1.5, 3.3, 1.76);
            frontWindow.rotation.y = Math.PI / 2;
            frontWindow.rotation.z = -0.3;
            carGroup.add(frontWindow);

            const frontWindowBack = frontWindow.clone();
            frontWindowBack.position.z = -1.76;
            carGroup.add(frontWindowBack);

            // Rear windshield
            const rearWindowGeo = new THREE.PlaneGeometry(2, 1.2);
            const rearWindow = new THREE.Mesh(rearWindowGeo, windowMaterial);
            rearWindow.position.set(-1.5, 3.2, 1.76);
            rearWindow.rotation.y = Math.PI / 2;
            rearWindow.rotation.z = 0.2;
            carGroup.add(rearWindow);

            const rearWindowBack = rearWindow.clone();
            rearWindowBack.position.z = -1.76;
            carGroup.add(rearWindowBack);

            // Side windows
            const sideWindowGeo = new THREE.PlaneGeometry(3.5, 1.3);
            const sideWindow = new THREE.Mesh(sideWindowGeo, windowMaterial);
            sideWindow.position.set(0, 3.3, 2.01);
            carGroup.add(sideWindow);

            const sideWindowOther = sideWindow.clone();
            sideWindowOther.position.z = -2.01;
            sideWindowOther.rotation.y = Math.PI;
            carGroup.add(sideWindowOther);
        }

        function createStripe() {
            const stripeGeometry = new THREE.BoxGeometry(7.5, 0.05, 0.6);
            const stripeMaterial = new THREE.MeshStandardMaterial({
                color: currentConfig.stripeColor,
                metalness: 0.8,
                roughness: 0.2
            });
            stripeMesh = new THREE.Mesh(stripeGeometry, stripeMaterial);
            stripeMesh.position.set(0.5, 3.02, 0);
            stripeMesh.visible = currentConfig.showStripe;
            carGroup.add(stripeMesh);
        }

        function createWheels() {
            wheels = [];
            const positions = [
                { x: 2.5, z: 2.3 },
                { x: 2.5, z: -2.3 },
                { x: -2.5, z: 2.3 },
                { x: -2.5, z: -2.3 }
            ];

            positions.forEach(pos => {
                const wheel = createWheel();
                wheel.position.set(pos.x, 1, pos.z);
                carGroup.add(wheel);
                wheels.push(wheel);
            });
        }

        function createWheel() {
            const wheelGroup = new THREE.Group();

            // Tire
            const tireGeometry = new THREE.CylinderGeometry(1, 1, 0.8, 32);
            const tireMaterial = new THREE.MeshStandardMaterial({
                color: 0x1a1a1a,
                roughness: 0.9,
                metalness: 0.1
            });
            const tire = new THREE.Mesh(tireGeometry, tireMaterial);
            tire.rotation.z = Math.PI / 2;
            tire.castShadow = true;
            wheelGroup.add(tire);

            // Rim
            const rimGeometry = new THREE.CylinderGeometry(0.7, 0.7, 0.85, 32);
            const rimMaterial = new THREE.MeshStandardMaterial({
                color: currentConfig.wheelColor,
                metalness: 0.9,
                roughness: 0.2
            });
            const rim = new THREE.Mesh(rimGeometry, rimMaterial);
            rim.rotation.z = Math.PI / 2;
            wheelGroup.add(rim);

            // Spokes based on style
            createSpokes(wheelGroup, currentConfig.wheelStyle);

            return wheelGroup;
        }

        function createSpokes(wheelGroup, style) {
            const spokeMaterial = new THREE.MeshStandardMaterial({
                color: currentConfig.wheelColor,
                metalness: 0.9,
                roughness: 0.2
            });

            let spokeCount = 5;
            if (style === 'racing') spokeCount = 10;
            if (style === 'classic') spokeCount = 3;

            for (let i = 0; i < spokeCount; i++) {
                const angle = (i / spokeCount) * Math.PI * 2;
                const spokeGeometry = new THREE.BoxGeometry(0.1, 0.6, 0.9);
                const spoke = new THREE.Mesh(spokeGeometry, spokeMaterial);
                spoke.position.x = Math.cos(angle) * 0.3;
                spoke.position.y = Math.sin(angle) * 0.3;
                spoke.rotation.z = angle;
                wheelGroup.add(spoke);
            }
        }

        function createSpoiler() {
            const spoilerGroup = new THREE.Group();
            
            // Main spoiler wing
            const wingGeometry = new THREE.BoxGeometry(0.3, 0.1, 4.5);
            const spoilerMaterial = new THREE.MeshStandardMaterial({
                color: currentConfig.bodyColor,
                metalness: 0.8,
                roughness: 0.3
            });
            const wing = new THREE.Mesh(wingGeometry, spoilerMaterial);
            wing.position.set(-4.2, 3.5, 0);
            wing.castShadow = true;
            spoilerGroup.add(wing);

            // Support pillars
            const pillarGeometry = new THREE.BoxGeometry(0.15, 0.8, 0.15);
            const pillarLeft = new THREE.Mesh(pillarGeometry, spoilerMaterial);
            pillarLeft.position.set(-4.1, 3, 1.5);
            spoilerGroup.add(pillarLeft);

            const pillarRight = pillarLeft.clone();
            pillarRight.position.z = -1.5;
            spoilerGroup.add(pillarRight);

            spoilerMesh = spoilerGroup;
            spoilerMesh.visible = currentConfig.showSpoiler;
            carGroup.add(spoilerMesh);
        }

        function createMirrors() {
            const mirrorMaterial = new THREE.MeshStandardMaterial({
                color: currentConfig.bodyColor,
                metalness: 0.7,
                roughness: 0.3
            });

            // Left mirror
            const mirrorGeometry = new THREE.BoxGeometry(0.3, 0.3, 0.6);
            mirrorLeft = new THREE.Mesh(mirrorGeometry, mirrorMaterial);
            mirrorLeft.position.set(1.5, 3.2, 2.5);
            mirrorLeft.castShadow = true;
            mirrorLeft.visible = currentConfig.showMirrors;
            carGroup.add(mirrorLeft);

            // Right mirror
            mirrorRight = mirrorLeft.clone();
            mirrorRight.position.z = -2.5;
            mirrorRight.visible = currentConfig.showMirrors;
            carGroup.add(mirrorRight);

            // Mirror glass
            const glassMaterial = new THREE.MeshStandardMaterial({
                color: 0x444444,
                metalness: 1,
                roughness: 0
            });
            const glassGeometry = new THREE.BoxGeometry(0.32, 0.25, 0.01);
            const glassLeft = new THREE.Mesh(glassGeometry, glassMaterial);
            glassLeft.position.set(1.5, 3.2, 2.65);
            glassLeft.visible = currentConfig.showMirrors;
            carGroup.add(glassLeft);

            const glassRight = glassLeft.clone();
            glassRight.position.z = -2.65;
            glassRight.visible = currentConfig.showMirrors;
            carGroup.add(glassRight);
        }

        function createLights() {
            const lightMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffcc,
                emissive: 0xffffcc,
                emissiveIntensity: 0.5,
                metalness: 0.3,
                roughness: 0.5
            });

            // Front headlights
            const headlightGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.2, 16);
            const headlightLeft = new THREE.Mesh(headlightGeometry, lightMaterial);
            headlightLeft.rotation.z = Math.PI / 2;
            headlightLeft.position.set(5.5, 2, 1.3);
            carGroup.add(headlightLeft);

            const headlightRight = headlightLeft.clone();
            headlightRight.position.z = -1.3;
            carGroup.add(headlightRight);

            // Tail lights
            const tailLightMaterial = new THREE.MeshStandardMaterial({
                color: 0xff0000,
                emissive: 0xff0000,
                emissiveIntensity: 0.5
            });
            const tailLightGeometry = new THREE.BoxGeometry(0.15, 0.4, 0.8);
            const tailLightLeft = new THREE.Mesh(tailLightGeometry, tailLightMaterial);
            tailLightLeft.position.set(-4.7, 2.2, 1.5);
            carGroup.add(tailLightLeft);

            const tailLightRight = tailLightLeft.clone();
            tailLightRight.position.z = -1.5;
            carGroup.add(tailLightRight);
        }

        function createBumpers() {
            const bumperMaterial = new THREE.MeshStandardMaterial({
                color: 0x1a1a1a,
                roughness: 0.6,
                metalness: 0.3
            });

            // Front bumper
            const frontBumperGeo = new THREE.BoxGeometry(1, 0.4, 4.2);
            const frontBumper = new THREE.Mesh(frontBumperGeo, bumperMaterial);
            frontBumper.position.set(5.5, 1.2, 0);
            frontBumper.castShadow = true;
            carGroup.add(frontBumper);

            // Rear bumper
            const rearBumper = frontBumper.clone();
            rearBumper.position.x = -5;
            carGroup.add(rearBumper);

            // Grille
            const grilleGeo = new THREE.BoxGeometry(0.1, 0.6, 2);
            const grilleMaterial = new THREE.MeshStandardMaterial({
                color: 0x0a0a0a,
                roughness: 0.8,
                metalness: 0.5
            });
            const grille = new THREE.Mesh(grilleGeo, grilleMaterial);
            grille.position.set(5.9, 1.8, 0);
            carGroup.add(grille);
        }

        function createEnvironment() {
            // Add some background buildings/objects
            const buildingMaterial = new THREE.MeshStandardMaterial({
                color: 0x2a2a3e,
                roughness: 0.7,
                metalness: 0.3
            });

            for (let i = 0; i < 8; i++) {
                const height = 10 + Math.random() * 20;
                const buildingGeo = new THREE.BoxGeometry(5, height, 5);
                const building = new THREE.Mesh(buildingGeo, buildingMaterial);
                
                const angle = (i / 8) * Math.PI * 2;
                const distance = 40;
                building.position.x = Math.cos(angle) * distance;
                building.position.z = Math.sin(angle) * distance;
                building.position.y = height / 2;
                building.castShadow = true;
                building.receiveShadow = true;
                
                scene.add(building);
            }

            // Add ambient particles/stars
            const particlesGeometry = new THREE.BufferGeometry();
            const particleCount = 200;
            const positions = new Float32Array(particleCount * 3);

            for (let i = 0; i < particleCount * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 100;
                positions[i + 1] = Math.random() * 50 + 10;
                positions[i + 2] = (Math.random() - 0.5) * 100;
            }

            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const particlesMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.1,
                transparent: true,
                opacity: 0.6
            });
            const particles = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(particles);
        }

        function setupEventListeners() {
            // Body color
            document.getElementById('body-color').addEventListener('input', (e) => {
                updateBodyColor(e.target.value);
            });

            document.querySelectorAll('#body-colors .color-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const color = e.target.dataset.color;
                    document.getElementById('body-color').value = color;
                    updateBodyColor(color);
                    
                    document.querySelectorAll('#body-colors .color-option').forEach(opt => 
                        opt.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });

            // Stripe color
            document.getElementById('stripe-color').addEventListener('input', (e) => {
                updateStripeColor(e.target.value);
            });

            document.querySelectorAll('#stripe-colors .color-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const color = e.target.dataset.color;
                    document.getElementById('stripe-color').value = color;
                    updateStripeColor(color);
                    
                    document.querySelectorAll('#stripe-colors .color-option').forEach(opt => 
                        opt.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });

            // Wheel color
            document.getElementById('wheel-color').addEventListener('input', (e) => {
                updateWheelColor(e.target.value);
            });

            // Material
            document.getElementById('body-material').addEventListener('change', (e) => {
                updateBodyMaterial(e.target.value);
            });

            // Wheel style
            document.getElementById('wheel-style').addEventListener('change', (e) => {
                updateWheelStyle(e.target.value);
            });

            // Window tint
            document.getElementById('window-tint').addEventListener('change', (e) => {
                updateWindowTint(parseFloat(e.target.value));
            });

            // Toggles
            document.getElementById('toggle-stripe').addEventListener('change', (e) => {
                toggleStripe(e.target.checked);
            });

            document.getElementById('toggle-spoiler').addEventListener('change', (e) => {
                toggleSpoiler(e.target.checked);
            });

            document.getElementById('toggle-mirrors').addEventListener('change', (e) => {
                toggleMirrors(e.target.checked);
            });

            // Window resize
            window.addEventListener('resize', onWindowResize);
        }

        function updateBodyColor(color) {
            currentConfig.bodyColor = color;
            carGroup.children.forEach(child => {
                if (child.material && child !== stripeMesh && 
                    !wheels.includes(child) && child !== spoilerMesh &&
                    child !== mirrorLeft && child !== mirrorRight) {
                    if (child.material.color) {
                        child.material.color.set(color);
                    }
                }
            });
            if (spoilerMesh) {
                spoilerMesh.children.forEach(child => {
                    if (child.material) child.material.color.set(color);
                });
            }
            if (mirrorLeft && mirrorLeft.material) mirrorLeft.material.color.set(color);
            if (mirrorRight && mirrorRight.material) mirrorRight.material.color.set(color);
        }

        function updateStripeColor(color) {
            currentConfig.stripeColor = color;
            if (stripeMesh && stripeMesh.material) {
                stripeMesh.material.color.set(color);
            }
        }

        function updateWheelColor(color) {
            currentConfig.wheelColor = color;
            wheels.forEach(wheel => {
                wheel.children.forEach(child => {
                    if (child.material && child.material.color) {
                        const currentColor = child.material.color.getHex();
                        if (currentColor !== 0x1a1a1a) { // Not tire
                            child.material.color.set(color);
                        }
                    }
                });
            });
        }

        function updateBodyMaterial(type) {
            currentConfig.bodyMaterial = type;
            let metalness = 0.7;
            let roughness = 0.3;

            switch(type) {
                case 'matte':
                    metalness = 0.1;
                    roughness = 0.9;
                    break;
                case 'glossy':
                    metalness = 0.9;
                    roughness = 0.1;
                    break;
                case 'carbon':
                    metalness = 0.5;
                    roughness = 0.4;
                    break;
            }

            carGroup.children.forEach(child => {
                if (child.material && child !== stripeMesh && !wheels.includes(child)) {
                    if (child.material.metalness !== undefined) {
                        child.material.metalness = metalness;
                        child.material.roughness = roughness;
                        child.material.needsUpdate = true;
                    }
                }
            });
        }

        function updateWheelStyle(style) {
            currentConfig.wheelStyle = style;
            // Remove old wheels
            wheels.forEach(wheel => carGroup.remove(wheel));
            wheels = [];
            // Create new wheels
            createWheels();
        }

        function updateWindowTint(level) {
            currentConfig.windowTint = level;
            carGroup.children.forEach(child => {
                if (child.material && child.material.transparent && child.material.opacity < 1) {
                    child.material.opacity = level;
                    child.material.needsUpdate = true;
                }
            });
        }

        function toggleStripe(visible) {
            currentConfig.showStripe = visible;
            if (stripeMesh) stripeMesh.visible = visible;
        }

        function toggleSpoiler(visible) {
            currentConfig.showSpoiler = visible;
            if (spoilerMesh) spoilerMesh.visible = visible;
        }

        function toggleMirrors(visible) {
            currentConfig.showMirrors = visible;
            if (mirrorLeft) mirrorLeft.visible = visible;
            if (mirrorRight) mirrorRight.visible = visible;
            
            // Also toggle mirror glass
            carGroup.children.forEach(child => {
                if (child.material && child.material.metalness === 1 && 
                    child.material.roughness === 0) {
                    child.visible = visible;
                }
            });
        }

        function setCameraView(view) {
            const duration = 1000; // Animation duration in ms
            const startPos = camera.position.clone();
            const startTime = Date.now();

            let targetPos;
            switch(view) {
                case 'front':
                    targetPos = new THREE.Vector3(20, 8, 0);
                    break;
                case 'rear':
                    targetPos = new THREE.Vector3(-20, 8, 0);
                    break;
                case 'side':
                    targetPos = new THREE.Vector3(0, 8, 20);
                    break;
                case 'top':
                    targetPos = new THREE.Vector3(0, 25, 0.1);
                    break;
                default:
                    targetPos = new THREE.Vector3(15, 8, 15);
            }

            function animateCamera() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function (ease-in-out)
                const eased = progress < 0.5 
                    ? 2 * progress * progress 
                    : 1 - Math.pow(-2 * progress + 2, 2) / 2;

                camera.position.lerpVectors(startPos, targetPos, eased);
                camera.lookAt(0, 2, 0);

                if (progress < 1) {
                    requestAnimationFrame(animateCamera);
                }
            }

            animateCamera();
        }

        function exportJSON() {
            const config = {
                ...currentConfig,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(config, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `car-config-${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function exportSnapshot() {
            // Render at higher resolution
            const originalWidth = renderer.domElement.width;
            const originalHeight = renderer.domElement.height;
            
            renderer.setSize(1920, 1080);
            renderer.render(scene, camera);
            
            renderer.domElement.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `car-snapshot-${Date.now()}.png`;
                link.click();
                URL.revokeObjectURL(url);
                
                // Restore original size
                renderer.setSize(originalWidth, originalHeight);
            });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            // Rotate car slowly
            if (carGroup) {
                carGroup.rotation.y += 0.002;
            }

            // Rotate wheels
            wheels.forEach(wheel => {
                wheel.rotation.x += 0.02;
            });

            // Update stats
            updateStats();

            renderer.render(scene, camera);
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            if (stats) {
                const triangles = renderer.info.render.triangles;
                const calls = renderer.info.render.calls;
                stats.innerHTML = `
                    Triangles: ${triangles.toLocaleString()}<br>
                    Draw Calls: ${calls}<br>
                    FPS: ${Math.round(1000 / 16)}
                `;
            }
        }

        // Start the application
        window.addEventListener('load', init);
    </script>
</body>
</html>