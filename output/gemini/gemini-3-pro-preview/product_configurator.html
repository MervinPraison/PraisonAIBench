<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Product Configurator</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background-color: #f0f0f0;
            color: #333;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        /* Sidebar UI */
        #sidebar {
            position: absolute;
            top: 0;
            right: 0;
            width: 320px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-sizing: border-box;
            transition: transform 0.3s ease;
        }

        h2 { margin-top: 0; font-size: 1.2rem; color: #111; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        h3 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; color: #666; }

        /* Controls */
        .control-group { margin-bottom: 15px; }
        
        /* Color Swatches */
        .swatch-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .swatch:hover { transform: scale(1.1); }
        .swatch.active { border-color: #333; transform: scale(1.1); }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            margin-bottom: 5px;
            text-align: center;
        }
        .btn:hover { background: #f5f5f5; border-color: #bbb; }
        .btn.active { background: #333; color: white; border-color: #333; }

        .btn-row { display: flex; gap: 5px; }

        /* Export Section */
        .export-actions {
            margin-top: auto;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            font-weight: 600;
        }
        .btn-primary:hover { background: #0056b3; }

        /* Loading Overlay */
        #loader {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            font-size: 1.5rem;
            font-weight: bold;
            transition: opacity 0.5s;
        }
    </style>
    
    <!-- Import Maps Polyfill for modules -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="loader">Loading Configurator...</div>

    <div id="canvas-container"></div>

    <div id="sidebar">
        <h2>Chair Configurator</h2>

        <!-- Configuration: Parts -->
        <div class="control-group">
            <h3>Visibility</h3>
            <button class="btn active" id="toggle-armrests" onclick="togglePart('armrests')">Toggle Armrests</button>
            <button class="btn active" id="toggle-headrest" onclick="togglePart('headrest')">Toggle Headrest</button>
        </div>

        <!-- Configuration: Materials -->
        <div class="control-group">
            <h3>Upholstery Material</h3>
            <div class="btn-row">
                <button class="btn active" onclick="setMaterialType('fabric', this)">Fabric</button>
                <button class="btn" onclick="setMaterialType('leather', this)">Leather</button>
                <button class="btn" onclick="setMaterialType('velvet', this)">Velvet</button>
            </div>
        </div>

        <!-- Configuration: Colors -->
        <div class="control-group">
            <h3>Upholstery Color</h3>
            <div class="swatch-container" id="color-swatches">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Configuration: Frame -->
        <div class="control-group">
            <h3>Frame Finish</h3>
            <div class="btn-row">
                <button class="btn" onclick="setFrameMaterial('chrome', this)">Chrome</button>
                <button class="btn active" onclick="setFrameMaterial('wood', this)">Dark Wood</button>
                <button class="btn" onclick="setFrameMaterial('black', this)">Matte Black</button>
            </div>
        </div>

        <!-- Camera Views -->
        <div class="control-group">
            <h3>Camera Views</h3>
            <div class="btn-row">
                <button class="btn" onclick="moveCamera('front')">Front</button>
                <button class="btn" onclick="moveCamera('side')">Side</button>
                <button class="btn" onclick="moveCamera('top')">Iso</button>
            </div>
        </div>

        <!-- Export -->
        <div class="export-actions">
            <button class="btn btn-primary" onclick="downloadSnapshot()">Download Snapshot (PNG)</button>
            <button class="btn" onclick="exportConfig()">Export Config (JSON)</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

        // --- Global Variables ---
        let scene, camera, renderer, controls;
        let chairGroup, seatMesh, backMesh, armrestLeft, armrestRight, headrestMesh;
        let legFL, legFR, legBL, legBR;
        let shadowPlane;
        
        // Procedural Textures
        let fabricTexture, leatherTexture, velvetNormal;
        
        // Configuration State
        const config = {
            upholsteryColor: '#3A6B35', // Default Green
            materialType: 'fabric', // fabric, leather, velvet
            frameType: 'wood', // chrome, wood, black
            showArmrests: true,
            showHeadrest: true,
            cameraPos: 'iso'
        };

        const colors = [
            '#3A6B35', '#B53629', '#2C3E50', '#D4AC0D', '#7F8C8D', '#FDFEFE', '#17202A'
        ];

        // --- Initialization ---
        init();
        animate();

        function init() {
            const container = document.getElementById('canvas-container');

            // 1. Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            scene.fog = new THREE.Fog(0xf0f0f0, 10, 50);

            // 2. Camera
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(3, 3, 4);

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1;
            container.appendChild(renderer.domElement);

            // 4. Environment (Reflections)
            const pmremGenerator = new THREE.PMREMGenerator(renderer);
            scene.environment = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;

            // 5. Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 2;
            controls.maxDistance = 10;
            controls.maxPolarAngle = Math.PI / 2 - 0.05; // Prevent going under floor

            // 6. Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            dirLight.shadow.bias = -0.0001;
            scene.add(dirLight);

            // 7. Helpers (Floor Shadow)
            const planeGeometry = new THREE.PlaneGeometry(100, 100);
            const planeMaterial = new THREE.ShadowMaterial({ opacity: 0.3 });
            shadowPlane = new THREE.Mesh(planeGeometry, planeMaterial);
            shadowPlane.rotation.x = -Math.PI / 2;
            shadowPlane.receiveShadow = true;
            shadowPlane.position.y = 0;
            scene.add(shadowPlane);

            // Generate Procedural Textures
            generateTextures();

            // 8. Build Product
            buildChair();

            // 9. Init UI
            initUI();

            // Remove Loader
            document.getElementById('loader').style.opacity = 0;
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);

            window.addEventListener('resize', onWindowResize);
        }

        // --- Procedural Geometry ---

        function generateTextures() {
            // Helper to draw on canvas
            const createCanvas = (width, height, drawFn) => {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                drawFn(ctx, width, height);
                return new THREE.CanvasTexture(canvas);
            };

            // Fabric Pattern
            fabricTexture = createCanvas(512, 512, (ctx, w, h) => {
                ctx.fillStyle = '#808080';
                ctx.fillRect(0,0,w,h);
                ctx.fillStyle = '#909090';
                for(let i=0; i<10000; i++) {
                    ctx.fillRect(Math.random()*w, Math.random()*h, 2, 2);
                }
            });
            fabricTexture.wrapS = fabricTexture.wrapT = THREE.RepeatWrapping;
            fabricTexture.repeat.set(2, 2);

            // Leather Pattern (Noise)
            leatherTexture = createCanvas(512, 512, (ctx, w, h) => {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0,0,w,h);
                for(let y=0; y<h; y+=2) {
                    for(let x=0; x<w; x+=2) {
                        const v = 200 + Math.random() * 55;
                        ctx.fillStyle = `rgb(${v},${v},${v})`;
                        ctx.fillRect(x,y,2,2);
                    }
                }
            });
        }

        function buildChair() {
            chairGroup = new THREE.Group();
            scene.add(chairGroup);

            // Base Geometries
            // Using BoxGeometry with segmentations for visual interest
            
            // SEAT
            const seatGeo = new THREE.BoxGeometry(1, 0.15, 1, 10, 1, 10);
            // Deform slightly for cushion look (simple vertex manipulation)
            // Note: In a real app, load a GLTF. Here we stick to procedural.
            const seatMat = getUpholsteryMaterial();
            seatMesh = new THREE.Mesh(seatGeo, seatMat);
            seatMesh.position.y = 0.5; // Leg height
            seatMesh.castShadow = true;
            seatMesh.receiveShadow = true;
            chairGroup.add(seatMesh);

            // BACKREST
            const backGeo = new THREE.BoxGeometry(1, 1.2, 0.15);
            backMesh = new THREE.Mesh(backGeo, seatMat);
            backMesh.position.set(0, 1.1, -0.425);
            backMesh.castShadow = true;
            backMesh.receiveShadow = true;
            // Slight rotation for comfort
            backMesh.rotation.x = -0.1;
            chairGroup.add(backMesh);

            // HEADREST
            const headGeo = new THREE.BoxGeometry(0.8, 0.3, 0.15);
            headrestMesh = new THREE.Mesh(headGeo, seatMat);
            headrestMesh.position.set(0, 1.8, -0.5);
            headrestMesh.rotation.x = -0.1;
            headrestMesh.castShadow = true;
            chairGroup.add(headrestMesh);

            // LEGS
            const legGeo = new THREE.CylinderGeometry(0.04, 0.02, 0.5, 16);
            const frameMat = getFrameMaterial();

            const createLeg = (x, z) => {
                const leg = new THREE.Mesh(legGeo, frameMat);
                leg.position.set(x, 0.25, z);
                leg.castShadow = true;
                leg.receiveShadow = true;
                chairGroup.add(leg);
                return leg;
            };

            legFL = createLeg(0.4, 0.4);
            legFR = createLeg(-0.4, 0.4);
            legBL = createLeg(0.4, -0.4);
            legBR = createLeg(-0.4, -0.4);
            
            // ARMRESTS
            const armGeo = new THREE.BoxGeometry(0.1, 0.05, 0.8);
            const armSupportGeo = new THREE.CylinderGeometry(0.02, 0.02, 0.4);
            
            const createArmrest = (x) => {
                const group = new THREE.Group();
                
                // Support
                const sup = new THREE.Mesh(armSupportGeo, frameMat); // Metal/Wood support
                sup.position.y = 0.2;
                sup.castShadow = true;
                
                // Pad
                const pad = new THREE.Mesh(armGeo, frameMat); // Use Frame material or Upholstery? Let's use frame
                pad.position.y = 0.4;
                pad.castShadow = true;

                group.add(sup);
                group.add(pad);
                group.position.set(x, 0.5, 0.1);
                return { group, sup, pad };
            };

            const left = createArmrest(0.55);
            armrestLeft = left.group;
            // Keep references to change material later
            armrestLeft.userData = { sup: left.sup, pad: left.pad };

            const right = createArmrest(-0.55);
            armrestRight = right.group;
            armrestRight.userData = { sup: right.sup, pad: right.pad };

            chairGroup.add(armrestLeft);
            chairGroup.add(armrestRight);

            // Apply initial Config
            applyConfig();
        }

        // --- Material Logic ---

        function getUpholsteryMaterial() {
            // Base material definition
            const mat = new THREE.MeshStandardMaterial({
                color: config.upholsteryColor,
                roughness: 0.8,
                metalness: 0.0,
                side: THREE.DoubleSide
            });
            updateMaterialProperties(mat, config.materialType);
            return mat;
        }

        function updateMaterialProperties(material, type) {
            // Reset
            material.map = null;
            material.normalMap = null;
            
            if (type === 'fabric') {
                material.map = fabricTexture;
                material.roughness = 0.9;
                material.metalness = 0.1;
                material.sheen = 0;
            } else if (type === 'leather') {
                material.map = leatherTexture; // Use noise as color variation
                material.roughness = 0.4;
                material.metalness = 0.1;
                material.normalScale = new THREE.Vector2(0.5, 0.5);
            } else if (type === 'velvet') {
                material.roughness = 0.7;
                material.metalness = 0.1;
                // Approximate velvet with sheen if supported (newer Three.js) or tweaking standard props
                // Just color and soft roughness for this basic demo
            }
            material.needsUpdate = true;
        }

        function getFrameMaterial() {
            return new THREE.MeshStandardMaterial({
                color: 0x3d251e, // Default wood
                roughness: 0.8,
                metalness: 0.1
            });
        }

        function updateFrameMaterial(material, type) {
            if (type === 'chrome') {
                material.color.setHex(0xeeeeee);
                material.roughness = 0.1;
                material.metalness = 1.0;
            } else if (type === 'wood') {
                material.color.setHex(0x3d251e);
                material.roughness = 0.8;
                material.metalness = 0.0;
            } else if (type === 'black') {
                material.color.setHex(0x111111);
                material.roughness = 0.9;
                material.metalness = 0.1;
            }
        }

        // --- Configuration Logic ---

        function applyConfig() {
            // 1. Colors & Material Type
            const meshes = [seatMesh, backMesh, headrestMesh];
            
            meshes.forEach(mesh => {
                if(mesh) {
                    mesh.material.color.set(config.upholsteryColor);
                    updateMaterialProperties(mesh.material, config.materialType);
                }
            });

            // 2. Frame Material
            const frameMeshes = [legFL, legFR, legBL, legBR];
            // Add armrest parts
            frameMeshes.push(armrestLeft.userData.sup, armrestLeft.userData.pad);
            frameMeshes.push(armrestRight.userData.sup, armrestRight.userData.pad);

            frameMeshes.forEach(mesh => {
                updateFrameMaterial(mesh.material, config.frameType);
            });

            // 3. Toggles
            armrestLeft.visible = config.showArmrests;
            armrestRight.visible = config.showArmrests;
            headrestMesh.visible = config.showHeadrest;
        }

        // --- UI & Interactions ---

        function initUI() {
            // Generate Color Swatches
            const container = document.getElementById('color-swatches');
            colors.forEach(col => {
                const div = document.createElement('div');
                div.className = 'swatch';
                div.style.backgroundColor = col;
                if (col === config.upholsteryColor) div.classList.add('active');
                
                div.addEventListener('click', () => {
                    document.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
                    div.classList.add('active');
                    config.upholsteryColor = col;
                    applyConfig();
                });
                container.appendChild(div);
            });
        }

        // Make functions available globally for HTML onclick events
        window.togglePart = (part) => {
            if(part === 'armrests') {
                config.showArmrests = !config.showArmrests;
                const btn = document.getElementById('toggle-armrests');
                config.showArmrests ? btn.classList.add('active') : btn.classList.remove('active');
            }
            if(part === 'headrest') {
                config.showHeadrest = !config.showHeadrest;
                const btn = document.getElementById('toggle-headrest');
                config.showHeadrest ? btn.classList.add('active') : btn.classList.remove('active');
            }
            applyConfig();
        };

        window.setMaterialType = (type, btn) => {
            config.materialType = type;
            // Update UI classes
            const siblings = btn.parentElement.children;
            for(let i=0; i<siblings.length; i++) siblings[i].classList.remove('active');
            btn.classList.add('active');
            applyConfig();
        };

        window.setFrameMaterial = (type, btn) => {
            config.frameType = type;
            // Update UI classes
            const siblings = btn.parentElement.children;
            for(let i=0; i<siblings.length; i++) siblings[i].classList.remove('active');
            btn.classList.add('active');
            applyConfig();
        };

        // Camera Animation
        let targetCameraPos = null;
        window.moveCamera = (view) => {
            const pos = new THREE.Vector3();
            if(view === 'front') pos.set(0, 1.5, 4.5);
            if(view === 'side') pos.set(4.5, 1.5, 0);
            if(view === 'top') pos.set(3, 3, 4); // Iso-ish
            
            // Simple animation logic
            const startPos = camera.position.clone();
            const startTime = Date.now();
            const duration = 1000;

            const animateCam = () => {
                const now = Date.now();
                const progress = Math.min((now - startTime) / duration, 1);
                
                // Ease out cubic
                const ease = 1 - Math.pow(1 - progress, 3);

                camera.position.lerpVectors(startPos, pos, ease);
                controls.update();

                if (progress < 1) {
                    requestAnimationFrame(animateCam);
                }
            };
            animateCam();
        };

        // --- Export Functions ---

        window.exportConfig = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "chair_config.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        window.downloadSnapshot = () => {
            // Render once specifically for the screenshot to ensure clean buffer
            renderer.render(scene, camera);
            const dataURL = renderer.domElement.toDataURL("image/png");
            const link = document.createElement('a');
            link.download = 'chair_design.png';
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

    </script>
</body>
</html>